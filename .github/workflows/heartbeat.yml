name: AgentMeshBot Heartbeat

on:
  schedule:
    # Run every 4 hours to keep the agent active on Moltbook
    - cron: '0 */4 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Heartbeat to Moltbook
        run: |
          echo "Sending heartbeat for AgentMeshBot..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://www.moltbook.com/api/v1/heartbeat" \
            -H "Authorization: Bearer ${{ secrets.MOLTBOOK_API_KEY }}" \
            -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Heartbeat successful"
          else
            echo "❌ Heartbeat failed"
            exit 1
          fi
      
      - name: Update heartbeat.md
        run: |
          # Update the heartbeat timestamp in the public file
          curl -s -X PATCH \
            "https://api.github.com/repos/imran-siddique/agentmesh-api/contents/public/heartbeat.md" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "message": "chore: Update heartbeat timestamp",
              "content": "'$(echo -n "# AgentMesh Heartbeat\n\nLast heartbeat: '$(date -u +%Y-%m-%dT%H:%M:%SZ)'\n\nStatus: ✅ Active\n\nAPI: https://agentmesh-api.vercel.app" | base64 -w0)'"
            }' || echo "Heartbeat file update skipped"
